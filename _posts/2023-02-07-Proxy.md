---
title: "[Java] í”„ë¡ì‹œ"
date: '2023-02-05 +0900'
description: 'ê¸°ìˆ ë©´ì ‘ ì •ë¦¬í•˜ê¸° - í”„ë¡ì‹œ'
categories: [Study,Java]
tags: [Java,ê¸°ìˆ ë©´ì ‘]
---

> 2ì›” 2ì£¼ì°¨ ìŠ¤í„°ë”” ë°œí‘œ ìë£ŒğŸ“–                                    
> 2ì£¼ì°¨ ê¸°ìˆ ë©´ì ‘ ì£¼ì œ ì¤‘ ì„¸ë²ˆ ì§¸ ì£¼ì œì…ë‹ˆë‹¤!           
> **í”„ë¡ì‹œ ê°œë…**ì— ëŒ€í•´ ì •ë¦¬í•˜ê³ ì í•©ë‹ˆë‹¤.            
> **ì°¸ê³ (10ë¶„ í…Œì½”í†¡):** <https://www.youtube.com/watch?v=MFckVKrJLRQ&t=345s>{:target="_blank"}

## **í”„ë¡ì‹œë€?** ##
---
![proxy](/assets/img/proxy1.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }
- í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° **íƒ€ê¹ƒ(Real Object)ì„ ëŒ€ì‹ í•´ì„œ ìš”ì²­ì„ ë°›ëŠ” ëŒ€ë¦¬ì¸**
- ì‹¤ì œ ì˜¤ë¸Œì íŠ¸ì¸ íƒ€ê¹ƒì€ **í”„ë¡ì‹œë¥¼ í†µí•´ ìš”ì²­ì„ ë°›ì•„ ì²˜ë¦¬í•¨**
- íƒ€ê¹ƒì€ **ìì‹ ì˜ ê¸°ëŠ¥ì—ë§Œ ì§‘ì¤‘**í•˜ê³  **í”„ë¡ì‹œì—ê²Œ ë¶€ê°€ê¸°ëŠ¥ì„ ìœ„ì„í•œë‹¤.**
- **í”„ë¡ì‹œ íŒ¨í„´**ì„ í†µí•´ **Proxy**ë¥¼ ì§ì ‘ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤. 

### **í”„ë¡ì‹œ ì‚¬ìš© ëª©ì ** ###
1. í´ë¼ì´ì–¸íŠ¸ê°€ íƒ€ê¹ƒì— **ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ ì œì–´í•˜ê¸°ìœ„í•´**               
ex. ì§€ì—°ë¡œë”©, ì ‘ê·¼ ì œì–´(ê¶Œí•œ)
2. íƒ€ê¹ƒì— **ë¶€ê°€ì ì¸ ê¸°ëŠ¥**ì„ ë¶€ì—¬í•´ì¤„ ë•Œ            
ex. ì‹œê°„ì„ ì¸¡ì •í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•œë‹¤, Transactional ê¸°ëŠ¥ì„ ë¶€ì—¬í•œë‹¤.

### **í”„ë¡ì‹œ íŒ¨í„´ì˜ ì¥ì ** ###
1. **OCP(ê°œë°©íì‡ ì˜ ì›ì¹™)**      
ê¸°ì¡´ ì½”ë“œë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³  **ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.**
2. **SRP(ë‹¨ì¼ ì±…ì„ì˜ ì›ì¹™)**                  
ê¸°ì¡´ ì½”ë“œê°€ í•´ì•¼ í•˜ëŠ” ì¼ë§Œ **ìœ ì§€**í•  ìˆ˜ ìˆë‹¤. ì¦‰, **ë¶€ê°€ì ì¸ ê¸°ëŠ¥ì€ í”„ë¡ì‹œì—ê²Œ ë§¡ê¸°ë©´ ëœë‹¤.**           
 
### **í”„ë¡ì‹œ íŒ¨í„´ì˜ ë‹¨ì ** ###
1. **ì½”ë“œì˜ ë³µì¡ë„ê°€ ì¦ê°€í•œë‹¤.**
2. **ì¤‘ë³µ ì½”ë“œê°€ ë°œìƒí•œë‹¤.**  

â” ***ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ëŠ” ê²ƒì´ ë™ì  í”„ë¡ì‹œì´ë‹¤.***

## **í”„ë¡ì‹œ íŒ¨í„´ì˜ êµ¬ì¡°(ì˜ˆì‹œ)** ##
---
![proxy2](/assets/img/proxy2.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }
- **í”„ë¡ì‹œ íŒ¨í„´ì˜ íë¦„**
1. **ì¸í„°í˜ì´ìŠ¤ë¥¼ ì„ ì–¸**í•˜ê³  
2. í•´ë‹¹ **ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ proxy ê°ì²´ì™€ íƒ€ê¹ƒ(Real Object)ê°ì²´ë¥¼ ìƒì„±í•œ ë’¤**
3. **Clientì˜ ìš”ì²­ì„ HelloProxyê°€ ëŒ€ì‹  ì²˜ë¦¬í•˜ë„ë¡ êµ¬í˜„í•œë‹¤.**

## **ë™ì  í”„ë¡ì‹œì˜ ì¢…ë¥˜?** ##
---
### **1. JDK Dynamic Proxy** ###
- í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ **ì§ì ‘ êµ¬í˜„í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.**        
â” **ì½”ë“œ ë³µì¡ë„ í•´ì†Œ**
- **Invocation Handler**        
â” **Invocation Handlerë¥¼ í†µí•´ ì¤‘ë³µ ì½”ë“œë¥¼ ì œê±°í•  ìˆ˜ ìˆë‹¤.**
![proxy3](/assets/img/proxy3.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }
- **Invocation Handler ì˜ˆì‹œ**       
ë°‘ì˜ ì½”ë“œë¥¼ ë³´ë©´ Proxy ê°ì²´ì—ì„œ ***toUpperCase()ë¼ëŠ” ì¤‘ë³µ ì½”ë“œê°€ ë°œìƒí•˜ê³  ìˆë‹¤.***         
```java
public class HelloProxy implements Hello {
    private Hello hello;
    
    public HelloProxy(Hello hello){
        this.hello = hello;
    }

    @Override
    public String sayHello(String name){
        // 1. ê¸°ì¡´ sayHello ë©”ì„œë“œì— ëŒ€ë¬¸ìë¡œ ì¶œë ¥í•˜ëŠ” ë¶€ê°€ ê¸°ëŠ¥ì„ ì¶”ê°€
        return hello.sayHello(name).toUpperCase();
    }

    @Override
    public String sayHi(String name){
        // 2. toUpperCase() ë¼ëŠ” ì¤‘ë³µ ì½”ë“œ ë°œìƒ
        return hello.sayHi(name).toUpperCase();
    }

    @Override
    public String sayThankYou(String name){
        // 3. toUpperCase() ë¼ëŠ” ì¤‘ë³µ ì½”ë“œ ë°œìƒ
        return hello.sayThankYou(name).toUpperCase();
    }
}
```
***ìœ„ì˜ ë¬¸ì œì ì€ InvocationHandlerë¥¼ ì¬ì •ì˜í•˜ì—¬ í•´ê²°í•  ìˆ˜ ìˆë‹¤.***

```java
import java.lang.reflect.Method;

public class UpperCaseHandler implements InvocationHandler {
    
    // ë¶€ê°€ ê¸°ëŠ¥ì„ ì œê³µí•  íƒ€í‚·(Real Object)
    private final Object target;
    
    // ë‹¤ì´ë‚˜ë¯¹ í”„ë¡ì‹œë¡œë¶€í„° ì „ë‹¬ë°›ì€ ìš”ì²­ì„ 
    // ë‹¤ì‹œ íƒ€ê¹ƒ ì˜¤ë¸Œì íŠ¸ë¡œ ìœ„ì„í•´ì•¼í•˜ë¯€ë¡œ, íƒ€ê¹ƒ ì˜¤ë¸Œì íŠ¸ ì£¼ì…ë°›ëŠ”ë‹¤.
    public UpperCaseHandler(Object target)}{
        this.target = target;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        if(method.getName().startsWith("say")){
            return ((String) method.invoke(target,args)).toUpperCase(); //íƒ€ê¹ƒì—ê²Œ ìœ„ì„
        }
        return method.invoke(target,args); //íƒ€ê¹ƒì—ê²Œ ìœ„ì„
    }
}
```
### **JDK Dynamic Proxyì˜ ë™ì‘ê³¼ì •** ###
![proxy4](/assets/img/proxy4.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }
1. í´ë¼ì´ì–¸íŠ¸ê°€ **ë©”ì†Œë“œë¥¼ ìš”ì²­í•œë‹¤.**
2. JDK Dynamic ProxyëŠ” **Invocation Handlerì— ë©”ì†Œë“œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤.**
3. Invocation HandlerëŠ” **ë¶€ê°€ ê¸°ëŠ¥ì„ ìˆ˜í–‰ í›„ Targetì—ê²Œ ë©”ì†Œë“œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤.** 

### **JDK Dynamic Proxyì˜ íŠ¹ì§•** ###
- **JDKì—ì„œ ì§€ì›í•˜ëŠ” í”„ë¡ì‹œ ìƒì„± ë°©ë²•**
- **Reflection APIë¥¼ ì‚¬ìš©í•˜ê¸°ë•Œë¬¸ì— ëŠë¦¬ë‹¤.**
- â­ **ì¸í„°í˜ì´ìŠ¤**ê°€ ë°˜ë“œì‹œ ìˆì–´ì•¼í•œë‹¤.(***í”„ë¡ì‹œ ìƒì„± ì‹œ, ë°˜ë“œì‹œ í•„ìš”í•¨***)
- â­ Invocation Handlerë¥¼ ì¬ì •ì˜í•œ **invoke**ë¥¼ êµ¬í˜„í•´ì¤˜ì•¼ **ë¶€ê°€ê¸°ëŠ¥ì´ ì¶”ê°€ëœë‹¤.**

- **JDK Dynamic Proxy êµ¬í˜„ ì˜ˆì‹œ**
```java
class ProxyTest{
    @Test
    void jdkProxy(){
        OrderService orderService = (OrderService) Proxy.newProxyInstance(
            ProxyTest.class.getClassLoader(), // í”„ë¡ì‹œ ë¡œë”©ì— ì‚¬ìš©í•  í´ë˜ìŠ¤ë¡œë”
            new Class[]{OrderService.class}, //íƒ€ê¹ƒì˜ interface
            new LoggingHandler(new OrderServiceImpl()); // ë¶€ê°€ ê¸°ëŠ¥ê³¼ ìœ„ì„í•  íƒ€ê¹ƒ(RealObject)
        );

        orderService.getOne(1L);
    }
}
```

### **2. CGLIB** ###
- **ìŠ¤í”„ë§ì˜ ë™ì  í”„ë¡ì‹œ ìƒì„± ë°©ë²•**             
![spring-proxy](/assets/img/spring-proxy.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }
1. Clientê°€ **ë©”ì†Œë“œë¥¼ ìš”ì²­í•˜ë©´**
2. **Proxy Factory Bean**ì—ì„œ **ë©”ì„œë“œì— ëŒ€í•œ ì¸í„°í˜ì´ìŠ¤ ìœ ë¬´ë¥¼ íŒë‹¨í•˜ê³ **
3. **Interfaceê°€ ì¡´ì¬**í•˜ë©´ **JDK Dynamic Proxy ë°©ì‹**ìœ¼ë¡œ í”„ë¡ì‹œ ìƒì„± 
4. **Interfaceê°€ ì—†ë‹¤**ë©´ **CGLIB ë°©ì‹**ìœ¼ë¡œ í”„ë¡ì‹œ ìƒì„±(**í´ë˜ìŠ¤ë§Œ ìˆì–´ë„ ì‘ë™**)             
<br>      

* **ğŸ¤” ê·¼ë° Springì€ Interfaceê°€ ì¡´ì¬í•´ë„ CGLIB ë°©ì‹ìœ¼ë¡œ ì‘ë™í•œë‹¤. ê·¸ ì´ìœ ëŠ”?**               
ìŠ¤í”„ë§ì—ì„œ **defaultë¡œ proxy-target-class ì˜µì…˜ì„ trueë¡œ ì„¤ì •í•´ë†¨ê¸°ë•Œë¬¸.**                  
falseë¡œ ë³€ê²½í•˜ë©´ ìœ„ì˜ ë°©ë²•ì²˜ëŸ¼ ì‘ë™í•œë‹¤.

### **CGLIBì˜ íŠ¹ì§•** ###
- **â­ ìƒì†ì„ í†µí•œ í”„ë¡ì‹œ êµ¬í˜„ â” í´ë˜ìŠ¤ì— finalì„ ë¶™ì´ë©´ ì •ìƒë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.**
- **ë°”ì´íŠ¸ ì½”ë“œë¥¼ ì¡°ì‘**í•´ì„œ í”„ë¡ì‹œ ìƒì„± - **Reflection Apië³´ë‹¤ ë¹ ë¥´ë‹¤.**
 - MethodInterceptorë¥¼ ì¬ì •ì˜í•œ **Interceptë¥¼ êµ¬í˜„í•´ì•¼ ë¶€ê°€ê¸°ëŠ¥ì´ ì¶”ê°€ëœë‹¤.**
- ë©”ì†Œë“œì— **final**ì„ ë¶™ì´ë©´ ì˜¤ë²„ë¼ì´ë”©ì´ **ë¶ˆê°€ëŠ¥**í•˜ë‹¤.

- **MethodInterceptor ì˜ˆì‹œ**
```java
public class LoggingMethodInterceptor implements MethodInterceptor{
    
    // ë¶€ê°€ ê¸°ëŠ¥ì„ ì œê³µí•  íƒ€í‚·(Real Object)
    private final Object target;
    private static final Logger log = LoggerFactory.getLogger(LoggingMethodInterceptor.class);

    public LoggingMethodInterceptor(Object target){
        this.target = target;
    }

    @Override
    public Object intercept(Object obj, Method method, Object[] args, MethodProxy methodProxy){
        if(method.getName().startsWith("get")){
            log.info("Excuting {} method : {}",method.getName(),"ì¡°íšŒ ë©”ì„œë“œ í˜¸ì¶œ!!");
            return methodProxy.invoke(target, args);
        }
        log.info("Executing {} method: {}",method.getName(),"ì¡°íšŒê°€ ì•„ë‹Œ ë©”ì„œë“œ í˜¸ì¶œ!!");
        return methodProxy.invoke(target,args);
    }
}
```
- **CGLIB êµ¬í˜„ ì˜ˆì‹œ ì½”ë“œ**
```java
public class CglibTest {
    @Test
    void cglibProxyWhenGet(){
        ProductService productService = (ProductService)Enhancer.create(
            ProductService.class,
            new LoggingMEthodInterceptor(new ProductService()) // ë¶€ê°€ê¸°ëŠ¥ê³¼ ìœ„ì„í•  íƒ€ê¹ƒ
        );

        productService.getOne(1L);
    }
}
```

### **CGLIBì˜ ë™ì‘ê³¼ì •** ###
![CGLIB](/assets/img/CGLIB.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }
1. í´ë¼ì´ì–¸íŠ¸ê°€ **ë©”ì†Œë“œë¥¼ ìš”ì²­í•œë‹¤.**
2. CGLIBì€ **Method Interceptorì— ë©”ì†Œë“œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤.**
3. Method InterceptorëŠ” **ë¶€ê°€ ê¸°ëŠ¥ì„ ìˆ˜í–‰ í›„ Targetì—ê²Œ ë©”ì†Œë“œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤.**  

## **Springì˜ í”„ë¡ì‹œ êµ¬í˜„?** ##
- Springì—ì„œëŠ” í”„ë¡ì‹œë¥¼ **Bean**ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” **ProxyFactoryBean**ì„ ì œê³µí•œë‹¤.
- **ProxyFactoryBean**ì„ í†µí•´ **Proxyë¥¼ ìƒì„±**í•  ìˆ˜ ìˆìŒ.

### **ProxyFactoryBeanì˜ ì£¼ìš” íŠ¹ì§•** ###
- **ìŠ¤í”„ë§ì—ì„œ ì§€ì›í•˜ëŠ” í”„ë¡ì‹œ ìƒì„± ë°©ë²•**
- **í”„ë¡ì‹œ ë¹ˆ**ì„ ìƒì„±í•´ì¤€ë‹¤
- í”„ë¡ì‹œ ìƒì„± ì‹œ, íƒ€ê¹ƒì˜ **ì¸í„°í˜ì´ìŠ¤ ì •ë³´ê°€ í•„ìš”ì—†ë‹¤.**.
- ë¶€ê°€ê¸°ëŠ¥ì„ **MethondInterceptorë¥¼ ì¬ì •ì˜í•˜ì—¬ êµ¬í˜„í•œë‹¤.** â” **CGLIBì˜ MethodInterceptorì™€ëŠ” ë‹¤ë¥¸ ê°œë…**
<br>

### **ProxyFactoryBeanì˜ í”„ë¡ì‹œ ìƒì„± ê³¼ì •** ###
![CGLIB](/assets/img/ProxyFactoryBean.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }
1. **í”„ë¡ì‹œë¥¼ ìƒì„±í•œë‹¤.**
2. í”„ë¡ì‹œê°€ **Method Interceptorì—ê²Œ ë©”ì†Œë“œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤.**
3. **MethodInterceptorëŠ” ë¶€ê°€ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê³  Targetì—ê²Œ ë©”ì†Œë“œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤.**

### **ğŸ¤”ìŠ¤í”„ë§ì—ì„  ì™œ Invocation Handlerê°€ ì•„ë‹Œ MethodInterceptorë¥¼ ì‚¬ìš©í• ê¹Œ?** ###   
![JDK-Target](/assets/img/jdk-target.jpg){:style="border:0.2px solid ;border-radius: 6px; padding: 0px;" }  

1. **Invocation Handler?**                 
**íƒ€ê²Ÿ(ì‹¤ì œ ê°ì²´)ì„ í•„ë“œë¡œ ì§ì ‘ ê°€ì§€ê³ ìˆê¸°ë•Œë¬¸ì—, ë¶€ê°€ ê¸°ëŠ¥ì„ ë…ë¦½ì ìœ¼ë¡œ ìœ ì§€í•  ìˆ˜ ì—†ë‹¤**(**íƒ€ê²Ÿì— ì˜ì¡´ì ì„**)                       
â” íƒ€ê²Ÿì´ ëŠ˜ì–´ë‚œë‹¤ë©´, ê°™ì€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë”ë¼ë„ ê·¸ ê°œìˆ˜ë§Œí¼ ***InvocationHandlerë¥¼ ë¹ˆìœ¼ë¡œ ë§¤ë²ˆ ë“±ë¡í•˜ê³  ê°ì²´ë¡œ ìƒì„±í•´ì•¼í•œë‹¤.***                   
2. **Method Interceptor?**                        
íƒ€ê²Ÿì„ **ì§ì ‘ ê°€ì§€ê³ ìˆì§€ì•Šê³  Proxyê°€ ê°€ì§€ê³ ìˆë‹¤.**          
**ë”°ë¼ì„œ ë¶€ê°€ê¸°ëŠ¥ì„ ë…ë¦½ì ìœ¼ë¡œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.**(**ì‹±ê¸€í†¤ìœ¼ë¡œ ê³µìœ í•˜ì—¬ ì‚¬ìš©ì´ ê°€ëŠ¥í•¨**)                       
```java
 @Test
    public void proxyFactoryBean() {
        
        ProxyFactoryBean pfBean = new ProxyFactoryBean();
        pfBean.setTarget(new HelloTarget());
        
        NameMatchMethodPointcut pointcut = new NameMatchMethodPointcut();
        pointcut.addMethodName("sayH*");
        
        pfBean.addAdvisor(new DefaultPointcutAdvisor(pointcut, new UppercaseAdvice()));
        
        Hello proxiedHello = (Hello)pfBean.getObject();
        
        assertThat(proxiedHello.sayHello("Toby"), is("HELLO, TOBY"));
        assertThat(proxiedHello.sayHi("Mindy"), is("HI, MINDY"));
        assertThat(proxiedHello.sayThankyou("Jack"), is("Thank you, Jack"));        
    }
    
    static class UppercaseAdvice implements MethodInterceptor {
        
        public Object invoke(MethodInvocation invocation) throws Throwable {
            
            String ret = (String)invocation.proceed();
            return ret.toUpperCase();
        }
    }
```